<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resonant Sanctuary: The Weaver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-color: #0c0a1e; /* Deep cosmic blue */
        }
        .stat-card {
            background-color: rgba(18, 16, 46, 0.7); /* Dark blue/purple */
            backdrop-filter: blur(10px);
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(76, 71, 128, 0.5);
        }
        .stat-card:hover {
            transform: translateY(-2px);
            background-color: rgba(28, 25, 68, 0.9);
        }
        .module-card {
            background-color: #1c1944; /* Muted cosmic blue */
            transition: all 0.2s ease-in-out;
            border: 1px solid rgba(76, 71, 128, 0.5);
        }
        .module-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(128, 90, 213, 0.2);
        }
        .log-panel {
            height: 150px;
            background-color: rgba(10, 8, 28, 0.9);
            border-top: 1px solid rgba(76, 71, 128, 0.5);
        }
        canvas {
            border-radius: 0.75rem;
        }
        .gemini-btn.loading, .gemini-btn:disabled {
            cursor: not-allowed;
            background-color: #4a5568;
            opacity: 0.7;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .log-entry {
            animation: fadeIn 0.5s ease-out;
        }
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: #1c1944;
            padding: 2rem;
            border-radius: 1rem;
            border: 1px solid rgba(76, 71, 128, 0.8);
            max-width: 500px;
            text-align: center;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
    </style>
</head>
<body class="text-indigo-100 flex flex-col h-screen">

    <!-- Top Bar -->
    <header class="w-full p-4 bg-[#1c1944] border-b border-indigo-900 shadow-lg z-10">
        <h1 class="text-2xl font-bold text-white">Resonant Sanctuary: The Weaver</h1>
    </header>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Panel: Modules & Controls -->
        <aside class="w-1/3 max-w-sm p-4 overflow-y-auto bg-[#1c1944] border-r border-indigo-900">
            <h2 class="text-xl font-semibold mb-4 text-white">Sanctuary Nodes</h2>
            <div id="modules-panel" class="space-y-4">
                <!-- Module cards will be injected here -->
            </div>
            <div class="mt-6 space-y-3">
                 <button id="advisor-btn" class="gemini-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors">
                    ðŸ“œ Ask Advisor
                </button>
                 <button id="seasonal-vision-btn" class="gemini-btn w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-colors">
                    âœ¨ Get Resonant Vision
                </button>
                <button id="next-turn-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                    Advance Cycle &gt;&gt;
                </button>
            </div>
        </aside>

        <!-- Center Panel: Village View & Stats -->
        <main class="flex-1 flex flex-col p-4">
            <!-- Stats Bar -->
            <div id="stats-bar" class="grid grid-cols-2 md:grid-cols-6 gap-4 mb-4">
                <!-- Stat cards will be injected here -->
            </div>

            <!-- Village Canvas -->
            <div class="flex-1 relative">
                 <canvas id="village-canvas" class="w-full h-full"></canvas>
            </div>
        </main>

    </div>

    <!-- Bottom Bar: Log -->
    <footer id="log-panel" class="w-full p-4 border-t border-indigo-900 overflow-y-auto">
        <h3 class="font-semibold text-lg mb-2 text-indigo-200">Aetheric Log</h3>
        <div id="log-output" class="text-sm text-indigo-300 space-y-1"></div>
    </footer>

    <!-- Event Modal -->
    <div id="event-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="event-title" class="text-2xl font-bold text-white mb-4"></h2>
            <p id="event-description" class="text-indigo-200 mb-6"></p>
            <div id="event-choices" class="flex justify-center space-x-4"></div>
        </div>
    </div>


    <script>
        // --- Canvas & DOM Elements ---
        const canvas = document.getElementById('village-canvas');
        const ctx = canvas.getContext('2d');
        const modulesPanel = document.getElementById('modules-panel');
        const statsBar = document.getElementById('stats-bar');
        const logOutput = document.getElementById('log-output');
        const nextTurnBtn = document.getElementById('next-turn-btn');
        const seasonalVisionBtn = document.getElementById('seasonal-vision-btn');
        const advisorBtn = document.getElementById('advisor-btn');
        const eventModal = document.getElementById('event-modal');
        const eventTitle = document.getElementById('event-title');
        const eventDescription = document.getElementById('event-description');
        const eventChoices = document.getElementById('event-choices');

        // --- Game State ---
        let gameState = {
            year: 2025,
            population: 20,
            energyPool: 50000,
            coherence: 70, // was wellBeing
            attunement: 60, // was harmony
            wisdomLevel: 1,
            insight: 0, // was knowledge
            insightPerTurn: 1,
            gameOver: false,
            villageGrid: [],
            streamPath: [],
            stars: [],
        };

        // --- Game Modules & Events (Resonant Themed) ---
        const modules = {
            sustenance: { name: "Sustenance Node", level: 0, levels: [ { cost: 0, description: "Wild foraging." },{ cost: 10000, tech: 1, knowledge: 0, description: "Crystal Gardens", effects: { coherence: 10, attunement: 5, costs: 1000 } },{ cost: 25000, tech: 2, knowledge: 20, description: "Atmospheric Condensers", effects: { coherence: 5, attunement: 10, costs: 2000 } },{ cost: 60000, tech: 3, knowledge: 50, description: "Bio-Luminescent Algae", effects: { coherence: 15, attunement: 15, costs: 5000 } } ]},
            energy: { name: "Energy Node", level: 0, levels: [ { cost: 0, description: "Ambient light." },{ cost: 15000, tech: 1, knowledge: 0, description: "Ley Line Taps", effects: { coherence: 5, attunement: 10, costs: 2000 } },{ cost: 40000, tech: 2, knowledge: 25, description: "Geothermal Vents", effects: { coherence: 5, attunement: 15, costs: 4000 } },{ cost: 90000, tech: 3, knowledge: 60, description: "Aetheric Harmonizer", effects: { coherence: 10, attunement: 20, costs: 8000 } } ]},
            cohesion: { name: "Cohesion Node", level: 0, levels: [ { cost: 0, description: "Shared silence." },{ cost: 5000, tech: 1, knowledge: 0, description: "Communal Chanting", effects: { coherence: 8, costs: 500 } },{ cost: 15000, tech: 2, knowledge: 15, description: "Resonance Workshops", effects: { coherence: 12, attunement: 5, costs: 1500 } }, { cost: 30000, tech: 2, knowledge: 30, description: "Archive of Echoes", effects: { coherence: 5, insightPerTurn: 5, costs: 2000 } } ]},
            festivals: { name: "Celebration Node", level: 0, levels: [ { cost: 0, description: "Marking the cycles." }, { cost: 8000, tech: 1, knowledge: 5, description: "Feast of Echoes", effects: { coherence: 10, costs: 1000 } }, { cost: 20000, tech: 2, knowledge: 25, description: "Festival of Floating Lights", effects: { coherence: 15, attunement: 5, costs: 2500 } }, { cost: 45000, tech: 3, knowledge: 55, description: "Great Conjunction", effects: { coherence: 20, attunement: 10, insight: 10, costs: 5000 } } ]},
            cycling: { name: "Recycling Node", level: 0, levels: [ { cost: 0, description: "Returning to dust." },{ cost: 5000, tech: 1, knowledge: 0, description: "Bio-Composting", effects: { attunement: 10, costs: 500 } },{ cost: 18000, tech: 2, knowledge: 20, description: "Matter Re-weavers", effects: { coherence: 5, attunement: 15, costs: 1500 } }, { cost: 50000, tech: 3, knowledge: 70, description: "Atomic Scrubber", effects: { coherence: 10, attunement: 25, costs: 6000 } } ]},
        };

        const events = [
            { title: "Cosmic Alignment", description: "The stars align, bathing the sanctuary in harmonious light.", choices: [ { text: "Meditate on it", effects: { coherence: 10, insight: 5 } }, { text: "Store the energy", effects: { attunement: 5, energyPool: 5000 } } ] },
            { title: "Resonant Feedback", description: "A dissonant frequency is causing mild agitation in the sanctuary.", choices: [ { text: "Find the source", effects: { coherence: -5, attunement: 5 } }, { text: "Let it pass", effects: { coherence: -10 } } ] },
            { title: "Wandering Mystic", description: "A traveler carrying ancient knowledge wishes to rest at the sanctuary.", choices: [ { text: "Welcome them (Cost: 2000)", effects: { coherence: 10, insight: 10, energyPool: -2000 } }, { text: "Send them on", effects: {} } ] },
        ];

        // --- Utility Functions ---
        const formatCurrency = (amount) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(amount);
        const log = (message, type = 'info') => {
            const colors = { info: 'text-indigo-300', success: 'text-teal-300', error: 'text-red-400', warning: 'text-amber-300', gemini: 'text-purple-300' };
            const p = document.createElement('p');
            p.innerHTML = `[Cycle ${gameState.year - 2024}] ${message}`;
            p.className = `${colors[type]} log-entry`;
            logOutput.prepend(p);
            if (logOutput.children.length > 20) {
                logOutput.lastChild.remove();
            }
        };

        // --- Rendering Functions ---
        const renderStats = () => {
            statsBar.innerHTML = `
                <div class="stat-card p-3 rounded-lg" title="Current Cycle"><p class="text-sm text-indigo-300 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-repeat mr-1" viewBox="0 0 16 16"><path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z"/><path fill-rule="evenodd" d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.5A5.002 5.002 0 0 0 8 3M3.5 12A5.002 5.002 0 0 0 8 15c1.552 0 2.94-.707 3.857-1.818a.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.5A5.002 5.002 0 0 0 8 12z"/></svg>Cycle</p><p class="text-xl font-bold">${gameState.year - 2024}</p></div>
                <div class="stat-card p-3 rounded-lg" title="Number of souls in the sanctuary."><p class="text-sm text-indigo-300 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-people-fill mr-1" viewBox="0 0 16 16"><path d="M7 14s-1 0-1-1 1-4 5-4 5 3 5 4-1 1-1 1zm4-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6m-5.784 6A2.24 2.24 0 0 1 5 13c0-1.355.68-2.75 1.936-3.72A6.3 6.3 0 0 0 5 9c-4 0-5 3-5 4s1 1 1 1zM4.5 8a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5"/></svg>Population</p><p class="text-xl font-bold">${gameState.population.toLocaleString()}</p></div>
                <div class="stat-card p-3 rounded-lg" title="Collective energy for new structures."><p class="text-sm text-indigo-300 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-gem mr-1" viewBox="0 0 16 16"><path d="M3.1.7a.5.5 0 0 1 .4-.2h9a.5.5 0 0 1 .4.2l2.976 3.974c.149.199.149.478 0 .678L12.8 8.974a.5.5 0 0 1-.4.2H3.6a.5.5 0 0 1-.4-.2L.124 5.352a.5.5 0 0 1 0-.678zM8 12.5a.5.5 0 0 1 .5.5v1.293l1.121-1.121a.5.5 0 0 1 .707 0l1.293 1.293a.5.5 0 0 1 0 .707L10.06 16.94a.5.5 0 0 1-.707 0L7.06 14.647a.5.5 0 0 1 0-.707l1.293-1.293a.5.5 0 0 1 .707 0L10.5 13.793V13a.5.5 0 0 1-.5-.5h-2a.5.5 0 0 1-.5-.5m-5-1.414L.121 7.207a.5.5 0 0 1 0-.707l2.293-2.293a.5.5 0 0 1 .707 0L4.293 5.293a.5.5 0 0 1 0 .707l-2.293 2.293a.5.5 0 0 1-.707 0m11.414 0L11.707 8a.5.5 0 0 1-.707 0L8.707 5.707a.5.5 0 0 1 0-.707l2.293-2.293a.5.5 0 0 1 .707 0l2.293 2.293a.5.5 0 0 1 0 .707"/></svg>Energy Pool</p><p class="text-xl font-bold">${formatCurrency(gameState.energyPool)}</p></div>
                <div class="stat-card p-3 rounded-lg" title="Collective well-being and focus."><p class="text-sm text-indigo-300 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-pulse-fill mr-1" viewBox="0 0 16 16"><path d="M1.475 9.025a.5.5 0 0 1 .484.022L4 10.586l1.483-2.471a.5.5 0 0 1 .82-.037L8 10.414l1.218-4.465a.5.5 0 0 1 .956-.046L12 11.414l1.051-1.752a.5.5 0 0 1 .87.52L12.232 14H3.768a.5.5 0 0 1-.484-.525z"/><path d="M8 1a2 2 0 0 1 2 2v2H6V3a2 2 0 0 1 2-2m-3.995 5.8a.5.5 0 0 1 .99 0l.225.449a.5.5 0 0 1-.99 0zM9 8.5a.5.5 0 0 1 .99 0l.225.449a.5.5 0 0 1-.99 0z"/><path d="M8 3.794a1.5 1.5 0 0 1 3 0V6h-6V3.794A1.5 1.5 0 0 1 8 3.794"/></svg>Coherence</p><p class="text-xl font-bold ${gameState.coherence < 50 ? 'text-red-400' : 'text-teal-300'}">${gameState.coherence}%</p></div>
                <div class="stat-card p-3 rounded-lg" title="Connection with the natural and cosmic energies."><p class="text-sm text-indigo-300 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-stars mr-1" viewBox="0 0 16 16"><path d="M7.657 6.247c.11-.33.576-.33.686 0l.645 1.937a2.89 2.89 0 0 0 1.829 1.828l1.936.645c.33.11.33.576 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.829l-.645 1.936a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828zM12.5 7.5l.645-1.937a.361.361 0 0 1 .686 0l.645 1.937a2.89 2.89 0 0 0 1.828 1.829l1.937.645a.361.361 0 0 1 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.828l-.645 1.937a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828l-1.937-.645a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828M5 2.5l.645-1.937a.361.361 0 0 1 .686 0l.645 1.937a2.89 2.89 0 0 0 1.828 1.829l1.937.645a.361.361 0 0 1 0 .686l-1.937.645a2.89 2.89 0 0 0-1.828 1.828l-.645 1.937a.361.361 0 0 1-.686 0l-.645-1.937a2.89 2.89 0 0 0-1.828-1.828L.342 7.147a.361.361 0 0 1 0-.686l1.937-.645a2.89 2.89 0 0 0 1.828-1.828z"/></svg>Attunement</p><p class="text-xl font-bold ${gameState.attunement < 50 ? 'text-red-400' : 'text-teal-300'}">${gameState.attunement}%</p></div>
                <div class="stat-card p-3 rounded-lg" title="Collective insight. Unlocks deeper truths."><p class="text-sm text-indigo-300 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-book-half mr-1" viewBox="0 0 16 16"><path d="M8.5 2.687c.654-.689 1.782-.886 3.112-.752 1.234.124 2.503.523 3.388 1.175a.5.5 0 0 1-.213.866c-.5.252-1.085.43-1.686.523-1.2.18-2.437.375-3.37.616-.934.24-1.844.52-2.706.811-1.213.416-2.53.8-3.687.943-1.158.143-2.358-.005-3.299-.343a.5.5 0 0 1 .213-.866c.885-.444 1.86-.57 2.9-.57 1.04 0 2.07.09 3.07.265.996.174 2.02.403 3.001.697zM8 13.5c-1.113 0-2.14-.134-3.07-.364-1.4-.35-2.556-.7-3.431-1.002a.5.5 0 0 1 .213-.866c.936.35 2.11.558 3.388.558 1.278 0 2.54-.21 3.687-.622 1.147-.412 2.305-.879 3.37-1.332a.5.5 0 0 1 .213.866c-.936.46-2.168.846-3.431 1.002C10.14 13.366 9.113 13.5 8 13.5z"/><path d="M8 1.783C7.015.936 5.587.81 4.287.94c-1.514.153-3.042.672-3.994 1.105A.5.5 0 0 0 0 2.5v11a.5.5 0 0 0 .707.455c.882-.4 2.303-.881 3.687-.881 1.386 0 2.824.481 3.994 1.105A.5.5 0 0 0 8 16v-15zM7.5 14.438V2.573c.51.034 1.02.048 1.5.048 1.47 0 2.848-.255 3.994-.744v9.645c-1.146.489-2.525.744-3.994.744-.48 0-.99-.014-1.5-.048z"/></svg>Insight</p><p class="text-xl font-bold text-blue-400">${gameState.insight} (+${gameState.insightPerTurn})</p></div>
            `;
        };

        const renderModules = () => {
            modulesPanel.innerHTML = '';
            for (const key in modules) {
                const mod = modules[key];
                const nextLevel = mod.level + 1;
                let upgradeButtonHTML = `<p class="text-sm text-indigo-400 mt-2">Fully harmonized.</p>`;
                
                if (nextLevel < mod.levels.length) {
                    const upgrade = mod.levels[nextLevel];
                    const canAfford = gameState.energyPool >= upgrade.cost;
                    const techMet = gameState.wisdomLevel >= upgrade.tech;
                    const knowledgeMet = gameState.insight >= upgrade.knowledge;
                    const canUpgrade = canAfford && techMet && knowledgeMet;
                    
                    let reason = '';
                    if (!canUpgrade) {
                        if (!techMet) reason = `Needs: Wisdom Lvl ${upgrade.tech}`;
                        else if (!knowledgeMet) reason = `Needs: ${upgrade.knowledge} Insight`;
                        else if (!canAfford) reason = `Needs: ${formatCurrency(upgrade.cost)} Energy`;
                    }

                    upgradeButtonHTML = `
                        <button class="w-full mt-2 py-2 px-3 text-sm font-semibold rounded-md transition-colors ${canUpgrade ? 'bg-teal-600 hover:bg-teal-700 text-white' : 'bg-gray-600 text-gray-400 cursor-not-allowed'}" 
                                ${canUpgrade ? `onclick="invest('${key}')"` : 'disabled'}>
                            ${canUpgrade ? `Attune: ${upgrade.description}` : reason}
                        </button>`;
                }
                
                let specialButtonHTML = '';
                if (key === 'cohesion') {
                    specialButtonHTML = `<button id="brainstorm-btn" class="gemini-btn w-full mt-2 py-2 px-3 text-sm font-semibold rounded-md transition-colors bg-indigo-600 hover:bg-indigo-700 text-white" onclick="getProjectIdea()">ðŸ’¡ Resonate Idea</button>`;
                }

                const card = document.createElement('div');
                card.className = "module-card p-4 rounded-lg";
                card.innerHTML = `
                    <h3 class="font-bold text-lg text-white">${mod.name} <span class="text-sm font-normal text-indigo-300">(Lvl ${mod.level})</span></h3>
                    <p class="text-sm text-indigo-200">${mod.levels[mod.level].description}</p>
                    ${upgradeButtonHTML}
                    ${specialButtonHTML}
                `;
                modulesPanel.appendChild(card);
            }
        };
        
        // --- Village Drawing ---
        const drawVillage = () => {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            // Draw background
            drawBackground();
            
            // Draw stream
            drawStream();
            
            // Sort and draw sprites
            gameState.villageGrid.sort((a, b) => a.y - b.y);
            gameState.villageGrid.forEach(item => {
                switch(item.type) {
                    case 'dome': drawDome(item.x, item.y, item.size); break;
                    case 'crystal_tree': drawCrystalTree(item.x, item.y, item.size); break;
                    case 'garden': drawGarden(item.x, item.y, item.size); break;
                    case 'archive': drawArchive(item.x, item.y, item.size); break;
                    case 'lantern': drawLantern(item.x, item.y, item.size); break;
                }
            });
        };

        const drawBackground = () => {
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#0c0a1e');
            gradient.addColorStop(1, '#1c1944');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw stars
            if (gameState.stars.length === 0) {
                for (let i = 0; i < 100; i++) {
                    gameState.stars.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        radius: Math.random() * 1.5,
                        alpha: 0.5 + Math.random() * 0.5
                    });
                }
            }
            gameState.stars.forEach(star => {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha * (0.75 + Math.sin(Date.now() / 1000 + star.x) * 0.25)})`;
                ctx.fill();
            });
        };

        const drawStream = () => {
             if (gameState.streamPath.length === 0) { // Generate path once
                let x = canvas.width * (0.2 + Math.random() * 0.6);
                let y = 0;
                gameState.streamPath.push({x, y});
                while(y < canvas.height) {
                    y += 20 + Math.random() * 20;
                    x += (Math.random() - 0.5) * 40;
                    gameState.streamPath.push({x, y});
                }
            }
            ctx.beginPath();
            ctx.moveTo(gameState.streamPath[0].x, gameState.streamPath[0].y);
            for(let i=1; i<gameState.streamPath.length - 2; i++) {
                const xc = (gameState.streamPath[i].x + gameState.streamPath[i+1].x) / 2;
                const yc = (gameState.streamPath[i].y + gameState.streamPath[i+1].y) / 2;
                ctx.quadraticCurveTo(gameState.streamPath[i].x, gameState.streamPath[i].y, xc, yc);
            }
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, 'rgba(128, 90, 213, 0.6)');
            gradient.addColorStop(1, 'rgba(60, 180, 220, 0.6)');
            ctx.strokeStyle = gradient;
            ctx.lineWidth = 8 + Math.sin(Date.now() / 500) * 2;
            ctx.shadowColor = '#a78bfa';
            ctx.shadowBlur = 15;
            ctx.stroke();
            ctx.shadowBlur = 0;
        };
        
        const addSprite = (type, count = 1) => {
            for (let i = 0; i < count; i++) {
                 gameState.villageGrid.push({
                    type: type,
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height,
                    size: 10 + Math.random() * 15,
                });
            }
        };

        const drawDome = (x, y, size) => {
            ctx.beginPath();
            ctx.arc(x, y, size, 0, Math.PI * 2);
            const gradient = ctx.createRadialGradient(x, y, 1, x, y, size);
            gradient.addColorStop(0, 'rgba(221, 214, 254, 0.8)');
            gradient.addColorStop(1, 'rgba(128, 90, 213, 0.5)');
            ctx.fillStyle = gradient;
            ctx.fill();
            ctx.strokeStyle = 'rgba(221, 214, 254, 0.9)';
            ctx.stroke();
        };

        const drawCrystalTree = (x, y, size) => {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x - size / 2, y - size * 1.5);
            ctx.lineTo(x, y - size * 2);
            ctx.lineTo(x + size / 2, y - size * 1.5);
            ctx.closePath();
            const gradient = ctx.createLinearGradient(x - size, y - size*2, x + size, y);
            gradient.addColorStop(0, '#a78bfa');
            gradient.addColorStop(1, '#4f46e5');
            ctx.fillStyle = gradient;
            ctx.globalAlpha = 0.7;
            ctx.fill();
            ctx.globalAlpha = 1;
        };

        const drawGarden = (x, y, size) => {
            ctx.fillStyle = 'rgba(76, 71, 128, 0.4)';
            ctx.fillRect(x - size, y - size/2, size * 2, size);
            for(let i = 0; i < 5; i++) {
                const flowerX = x - size + Math.random() * size * 2;
                const flowerY = y - size/2 + Math.random() * size;
                ctx.fillStyle = ['#fde047', '#a78bfa', '#f472b6'][Math.floor(Math.random() * 3)];
                ctx.beginPath();
                ctx.arc(flowerX, flowerY, 3, 0, Math.PI * 2);
                ctx.shadowColor = ctx.fillStyle;
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        };

        const drawArchive = (x, y, size) => {
            ctx.fillStyle = '#4f46e5';
            ctx.fillRect(x - size, y - size / 2, size * 2, size);
            ctx.strokeStyle = '#fde047';
            ctx.lineWidth = 2;
            ctx.strokeRect(x - size, y - size / 2, size * 2, size);
            ctx.fillStyle = '#fde047';
            ctx.font = `${size}px Arial`;
            ctx.fillText("âœ¨", x - size/4, y + size/4);
        };
        
        const drawLantern = (x, y, size) => {
            const time = Date.now();
            const newY = y + Math.sin(time / 1000 + x) * 10; // Bobbing motion
            ctx.beginPath();
            ctx.arc(x, newY, size / 2, 0, Math.PI * 2);
            const gradient = ctx.createRadialGradient(x, newY, 1, x, newY, size / 2);
            gradient.addColorStop(0, 'rgba(253, 224, 71, 1)');
            gradient.addColorStop(1, 'rgba(253, 224, 71, 0)');
            ctx.fillStyle = gradient;
            ctx.fill();
        };

        // --- Gemini API Integration ---
        async function callGemini(prompt, button) {
            if (button) { button.disabled = true; button.classList.add('loading'); button.innerHTML = 'AI is thinking...'; }
            try {
                const apiKey = ""; const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0) return result.candidates[0].content.parts[0].text;
                return "The aetheric connection is unclear. Try again.";
            } catch (error) { console.error("Gemini API Error:", error); return "The connection to the cosmic consciousness was lost.";
            } finally {
                 if (button) {
                    button.disabled = false; button.classList.remove('loading');
                    if(button.id === 'seasonal-vision-btn') button.innerHTML = 'âœ¨ Get Resonant Vision';
                    if(button.id === 'brainstorm-btn') button.innerHTML = 'ðŸ’¡ Resonate Idea';
                    if(button.id === 'advisor-btn') button.innerHTML = 'ðŸ“œ Ask Advisor';
                }
            }
        }

        async function getSeasonalVision() {
            const prompt = `You are a storyteller for a game called Resonant Sanctuary. Write a short, poetic, 2-3 sentence story for the current cycle. Mention cosmic energy, the river of light, or the crystal formations. The sanctuary stats are: Population: ${gameState.population}, Coherence: ${gameState.coherence}%, Attunement: ${gameState.attunement}%. Keep it mystical and evocative.`;
            const story = await callGemini(prompt, seasonalVisionBtn);
            log(`âœ¨ ${story}`, 'gemini');
        }
        async function getAdvisorInsight() {
            const prompt = `You are an AI advisor in the game Resonant Sanctuary. The player needs your help. Based on these stats (Coherence: ${gameState.coherence}%, Attunement: ${gameState.attunement}%, Energy Pool: ${formatCurrency(gameState.energyPool)}, Insight: ${gameState.insight}), give a single, actionable piece of advice. Start with "The sanctuary whispers..." and keep it under 30 words.`;
            const advice = await callGemini(prompt, advisorBtn);
            log(`ðŸ“œ ${advice}`, 'gemini');
        }
        window.getProjectIdea = async () => {
            const brainstormBtn = document.getElementById('brainstorm-btn');
            const prompt = `You are a creative assistant for a game called Resonant Sanctuary. Suggest a single, mystical, and creative community project idea. The idea should be just a short phrase or title. For example: "Chart the star-fields," or "Build a sound labyrinth."`;
            const idea = await callGemini(prompt, brainstormBtn);
            log(`ðŸ’¡ New Resonance: ${idea}`, 'gemini');
        }

        // --- Game Logic ---
        window.invest = (moduleKey) => {
            const mod = modules[moduleKey];
            const nextLevel = mod.level + 1;
            if (nextLevel >= mod.levels.length) return;
            const upgrade = mod.levels[nextLevel];
            if (gameState.energyPool >= upgrade.cost && gameState.wisdomLevel >= upgrade.tech && gameState.insight >= upgrade.knowledge) {
                gameState.energyPool -= upgrade.cost;
                gameState.insight -= upgrade.knowledge;
                mod.level = nextLevel;
                if(upgrade.effects.insightPerTurn) gameState.insightPerTurn += upgrade.effects.insightPerTurn;
                log(`Attuned ${mod.name} to Lvl ${nextLevel}: ${upgrade.description}`, 'success');
                if (moduleKey === 'sustenance') addSprite('garden', 3);
                if (upgrade.description === "Archive of Echoes") addSprite('archive', 1);
                if (upgrade.description === "Festival of Floating Lights") {
                    for(let i=0; i<15; i++) addSprite('lantern');
                }
                updateAll();
            }
        };

        function triggerEvent() {
            const eventData = events[Math.floor(Math.random() * events.length)];
            eventTitle.textContent = eventData.title;
            eventDescription.textContent = eventData.description;
            eventChoices.innerHTML = '';
            eventData.choices.forEach(choice => {
                const button = document.createElement('button');
                button.textContent = choice.text;
                button.className = 'bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg';
                button.onclick = () => resolveEvent(choice.effects);
                eventChoices.appendChild(button);
            });
            eventModal.classList.add('visible');
        }

        function resolveEvent(effects) {
            log(`A new resonance is felt...`, 'warning');
            gameState.coherence = Math.max(0, Math.min(100, gameState.coherence + (effects.coherence || 0)));
            gameState.attunement = Math.max(0, Math.min(100, gameState.attunement + (effects.attunement || 0)));
            gameState.energyPool += effects.energyPool || 0;
            gameState.insight += effects.insight || 0;
            eventModal.classList.remove('visible');
            updateAll();
        }
        
        const handleNextTurn = () => {
            if (gameState.gameOver) return;
            gameState.year++;
            gameState.insight += gameState.insightPerTurn;
            let yearlyIncome = 200 * gameState.population; let yearlyCosts = 100 * gameState.population;
            let coherenceChange = 0; let attunementChange = 0;
            for (const key in modules) {
                const mod = modules[key];
                if (mod.level > 0) {
                    const effects = mod.levels[mod.level].effects;
                    yearlyCosts += effects.costs || 0;
                    coherenceChange += effects.coherence || 0;
                    attunementChange += effects.attunement || 0;
                    if(effects.insight) gameState.insight += effects.insight;
                }
            }
            const growthRate = (gameState.coherence - 50) / 500;
            const popChange = Math.floor(gameState.population * growthRate);
            if (popChange > 0) { for(let i=0; i<popChange; i++) { addSprite('dome', 1); addSprite('crystal_tree', 2); } }
            gameState.population += popChange;
            gameState.energyPool += yearlyIncome - yearlyCosts;
            gameState.coherence = Math.max(0, Math.min(100, gameState.coherence + coherenceChange - (gameState.coherence < 60 ? 1 : -1)));
            gameState.attunement = Math.max(0, Math.min(100, gameState.attunement + attunementChange - (gameState.attunement < 50 ? 1 : 0)));
            if (gameState.population > 50 && gameState.wisdomLevel === 1) { gameState.wisdomLevel = 2; log("Shared Wisdom! The sanctuary has reached Wisdom Level 2.", 'success'); }
            if (gameState.population > 150 && gameState.wisdomLevel === 2) { gameState.wisdomLevel = 3; log("Deep Insight! The sanctuary has reached Wisdom Level 3.", 'success'); }
            log(`Cycle Report: Population changed by ${popChange > 0 ? '+' : ''}${popChange}. Net energy flow: ${formatCurrency(yearlyIncome - yearlyCosts)}.`);
            if (Math.random() < 0.3) { setTimeout(triggerEvent, 500); }
            if (gameState.energyPool < 0) {
                log("Dissonance Cascade! The sanctuary's energy pool is empty!", 'error');
                gameState.gameOver = true; nextTurnBtn.disabled = true; nextTurnBtn.innerText = "Game Over"; nextTurnBtn.classList.add('cursor-not-allowed', 'bg-red-800');
            }
            if (gameState.coherence < 10) {
                log("Dissonance Cascade! The sanctuary's coherence has collapsed.", 'error');
                gameState.gameOver = true; nextTurnBtn.disabled = true; nextTurnBtn.innerText = "Game Over"; nextTurnBtn.classList.add('cursor-not-allowed', 'bg-red-800');
            }
            updateAll();
        };

        const updateAll = () => { renderStats(); renderModules(); drawVillage(); };
        nextTurnBtn.addEventListener('click', handleNextTurn);
        seasonalVisionBtn.addEventListener('click', getSeasonalVision);
        advisorBtn.addEventListener('click', getAdvisorInsight);
        window.addEventListener('resize', drawVillage);
        const init = () => {
            log("Welcome, Weaver. The first cycle begins. May your sanctuary resonate with harmony.", "success");
            addSprite('dome', 10); addSprite('crystal_tree', 30);
            updateAll();
        };
        init();
    </script>
</body>
</html>
